name: Update LeetCode Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # This is the key permission needed
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Create update script
        run: |
          cat > update_stats.py << 'SCRIPT_EOF'
          import requests
          import re
          from datetime import datetime
          
          response = requests.get('https://leetcode-stats-api.herokuapp.com/amfooladgar')
          data = response.json()
          
          if data['status'] == 'success':
              with open('README.md', 'r') as f:
                  readme = f.read()
              
              stats_section = """<!-- LEETCODE_STATS:START -->
          ![Total Solved](https://img.shields.io/badge/Total_Solved-{totalSolved}-brightgreen?style=flat-square)
          ![Easy](https://img.shields.io/badge/Easy-{easySolved}-5cb85c?style=flat-square)
          ![Medium](https://img.shields.io/badge/Medium-{mediumSolved}-f0ad4e?style=flat-square)
          ![Hard](https://img.shields.io/badge/Hard-{hardSolved}-d9534f?style=flat-square)
          
          **Acceptance Rate:** {acceptanceRate}% | **Ranking:** {ranking:,} | **Contribution Points:** {contributionPoints:,}
          <!-- LEETCODE_STATS:END -->""".format(
                  totalSolved=data['totalSolved'],
                  easySolved=data['easySolved'],
                  mediumSolved=data['mediumSolved'],
                  hardSolved=data['hardSolved'],
                  acceptanceRate=data['acceptanceRate'],
                  ranking=data['ranking'],
                  contributionPoints=data['contributionPoints']
              )
              
              readme = re.sub(
                  r'<!-- LEETCODE_STATS:START -->.*?<!-- LEETCODE_STATS:END -->',
                  stats_section,
                  readme,
                  flags=re.DOTALL
              )
              
              total_problems = data['totalQuestions']
              solved = data['totalSolved']
              easy_solved = data['easySolved']
              medium_solved = data['mediumSolved']
              hard_solved = data['hardSolved']
              total_easy = data['totalEasy']
              total_medium = data['totalMedium']
              total_hard = data['totalHard']
              
              easy_pct = (easy_solved / total_easy * 100) if total_easy > 0 else 0
              medium_pct = (medium_solved / total_medium * 100) if total_medium > 0 else 0
              hard_pct = (hard_solved / total_hard * 100) if total_hard > 0 else 0
              overall_pct = (solved / total_problems * 100) if total_problems > 0 else 0
              
              easy_bar = 'â–ˆ' * int(easy_pct / 5) + 'â–‘' * (20 - int(easy_pct / 5))
              medium_bar = 'â–ˆ' * int(medium_pct / 5) + 'â–‘' * (20 - int(medium_pct / 5))
              hard_bar = 'â–ˆ' * int(hard_pct / 5) + 'â–‘' * (20 - int(hard_pct / 5))
              
              progress_section = """```
          Total Problems: {total_problems:,}
          Solved: {solved} ({overall_pct:.1f}%)
          
          Easy:     {easy_solved}/{total_easy}   ({easy_pct:.1f}%)  {easy_bar}
          Medium:  {medium_solved}/{total_medium:,} ({medium_pct:.1f}%)  {medium_bar}
          Hard:     {hard_solved}/{total_hard}   ({hard_pct:.1f}%)  {hard_bar}
          ```""".format(
                  total_problems=total_problems,
                  solved=solved,
                  overall_pct=overall_pct,
                  easy_solved=easy_solved,
                  total_easy=total_easy,
                  easy_pct=easy_pct,
                  easy_bar=easy_bar,
                  medium_solved=medium_solved,
                  total_medium=total_medium,
                  medium_pct=medium_pct,
                  medium_bar=medium_bar,
                  hard_solved=hard_solved,
                  total_hard=total_hard,
                  hard_pct=hard_pct,
                  hard_bar=hard_bar
              )
              
              readme = re.sub(
                  r'```\nTotal Problems:.*?```',
                  progress_section,
                  readme,
                  flags=re.DOTALL
              )
              
              current_date = datetime.now().strftime('%Y-%m-%d')
              readme = re.sub(
                  r'<!-- LAST_UPDATE:START -->.*?<!-- LAST_UPDATE:END -->',
                  '<!-- LAST_UPDATE:START -->' + current_date + '<!-- LAST_UPDATE:END -->',
                  readme
              )
              
              with open('README.md', 'w') as f:
                  f.write(readme)
              
              print("Stats updated successfully! Total solved: " + str(solved))
          else:
              print("Failed to fetch stats")
              exit(1)
          SCRIPT_EOF
      
      - name: Run update script
        run: python update_stats.py
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Auto-update LeetCode stats" && git push)
